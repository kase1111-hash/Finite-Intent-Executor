name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build Contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx hardhat build

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx hardhat test

  coverage:
    name: Coverage Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npx hardhat test --coverage
      - name: Check coverage threshold
        run: |
          # Extract statement coverage percentage from coverage summary
          COVERAGE=$(npx hardhat test --coverage 2>&1 | grep "All files" | awk '{print $4}' | sed 's/%//')
          echo "Statement coverage: ${COVERAGE}%"
          if [ -z "$COVERAGE" ]; then
            echo "Warning: Could not parse coverage. Skipping threshold check."
            exit 0
          fi
          THRESHOLD=80
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            exit 1
          fi

  foundry-test:
    name: Foundry Fuzz Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable
      - name: Run Foundry tests
        run: forge test --profile ci -vvv

  # [Audit fix: I-4, I-16, I-19] Security scanning job
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci

      # [Audit fix: I-16] Dependency vulnerability scanning
      - name: npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      # [Audit fix: I-4] Secrets scanning
      - name: Check for committed secrets
        run: |
          # Check that .env file is not committed
          if [ -f .env ]; then
            echo "ERROR: .env file found in repository!"
            exit 1
          fi
          # Check for common secret patterns in tracked files
          if git grep -l 'PRIVATE_KEY=0x[0-9a-fA-F]\{64\}' -- ':!.env.example' ':!*.md'; then
            echo "ERROR: Potential private key found in tracked files!"
            exit 1
          fi

      # [Audit fix: I-19] Static analysis with Slither
      - name: Install Slither
        run: pip3 install slither-analyzer
      - name: Run Slither
        run: slither . --filter-paths "node_modules" --exclude-informational --exclude-low
        continue-on-error: true

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
      - run: npx eslint src/
